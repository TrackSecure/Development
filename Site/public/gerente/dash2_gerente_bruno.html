<!DOCTYPE html>
<html lang="pt-br   ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Comparação - Mês atual e meses anteriores</title>
    <link rel="shortcut icon" href="imgs/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="dash2_gerente_bruno.css">
    <script src="./js/sessao.js"></script>
</head>

<!-- <body onload="listarServidores(), validarSessao('Gerente de Monitoramento de Servidores', 'dashboard_inicial_analista,html')"> -->
<body onload="mostrar_nome(), mostrarQtdAlertas()">
    <div class="pagina">
        <header>
            <div class="perfil">
                <div class="texto">
                    <span id="user"></span>
                </div>
            </div>
            <div class="botao">
                <div class="container">
                    <button onclick="window.location='../cadastro_estacao.html'">Cadastros</button>
                    <button onclick="window.location='../dashboard_inicial_gerente.html'">Início</button>
                    <button onclick="sair()">Sair</button>
                </div>
            </div>
        </header>
        <div class="paginaDash">
            <div class="menu">
                <div class="selects">
                    <div>
                        <span>Selecione uma linha</span>
                        <select name="linhas" id="select_estacao" onchange="listarServidores()">
                            <option value="azul">Azul</option>
                            <option value="verde">Verde</option>
                            <option value="vermelha">Vermelha</option>
                            <option value="prata">Prata</option>
                        </select>
                    </div>
                    <div>
                        <span>Selecione um servidor</span>
                        <select name="servidores" id="select_servidor" onchange="mostrarQtdAlertas()">
                        </select>
                    </div>
                </div>
                <div class="logo">
                    <img src="../imgs/logo.png" alt="logo" class="logo-img">
                    <a href="index.html" class="logo_txt"><span>Track</span>Secure</a>
                </div>
            </div>
            <div class="topo_dash">
                <div>
                    <span>Aumento/redução de alertas de prioridade
                      <select name="" id="select_prioridade">
                        <option value="High">Alta</option>
                        <option value="Medium">Média</option>
                        <option selected value="Low">Baixa</opWstion>
                    </select>
                    por componente (Servidor 1) em relação a
                    <select name="" id="select_mes">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option selected value="10">Outubro</option>
                    </select>
                    </span>
                </div>
                <div class="cards">
                    <div>
                        <h3 style="color: #1ec9d5;">CPU</h3>
                        <div id="div_cpu" class=""><span id="card_cpu" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                    <div>
                        <h3 style="color: #218c93;">RAM</h3>
                        <div id="div_ram" class=""><span id="card_ram" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                    <div>
                        <h3 style="color: #122178;">Disco</h3>
                        <div id="div_disco" class=""><span id="card_disco" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                </div>
                <div class="graficos">
                    <div>
                        <h5 style="text-align: center;">Gráfico de inclinação do aumento/redução <br> da quantidade de problemas por componente do Servidor 1</h2>
                        <div id="grafico1"></div>
                    </div>
                    <hr style="width: 0.2rem; background-color: #092a45;">
                    <div>
                        <h4 style="text-align: center;">Tempo total de Downtime no Servidor 1</h4>    
                        <div id="grafico2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    var alertasCpuMesAnterior;
    var alertasRamMesAnterior;
    var alertasDiscoMesAnterior;
    var alertasCpuMesRecente;
    var alertasRamMesRecente;
    var alertasDiscoMesRecente;

    function mostrar_nome() {
        var nome = sessionStorage.NOME_USUARIO;
        user.innerHTML = `Olá, ${nome}`;
    }

    function listarServidores() {
        var fkEmpresa = sessionStorage.ID_EMPRESA;

        fetch(`/servidor/listar/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    resposta.forEach((servidor) => {
                    select_servidor.innerHTML += `<option value='${servidor.MacAddress}'>${servidor.nome}</option>`;
                });
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados dos servidores: ${error.message}`);
            });
    }

    function buscarQtdAlertas() {
      var fkServidor = select_servidor.value;
      var prioridade = select_prioridade.value;
      var mes = select_mes.value;

      fetch(`/gerenteBruno/buscarQtdAlertas/'${fkServidor}'/${prioridade}/${mes}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                  alertasCpuMesAnterior = resposta[0].qtdAlertas;
                  alertasRamMesAnterior = resposta[1].qtdAlertas;
                  alertasDiscoMesAnterior = resposta[2].qtdAlertas;
                  alertasCpuMesRecente = resposta[3].qtdAlertas;
                  alertasRamMesRecente = resposta[4].qtdAlertas;
                  alertasDiscoMesRecente = resposta[5].qtdAlertas;
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados dos servidores: ${error.message}`);
            });
    }

    function mostrarQtdAlertas() {
      listarServidores();
      buscarQtdAlertas();
      var diferencaCpu = alertasCpuMesRecente - alertasCpuMesAnterior;
      var diferencaRam = alertasRamMesRecente - alertasRamMesAnterior;
      var diferencaDisco = alertasDiscoMesRecente - alertasDiscoMesAnterior;
      if (diferencaCpu > 0) {
        card_cpu.innerHTML = "&#8593;" + diferencaCpu;
        div_cpu.class = "card_aumento";
      } else {
        card_cpu.innerHTML = "&#8595;" + Math.abs(diferencaCpu);
        div_cpu.class = "card_reducao";
      }
      if (diferencaRam > 0) {
        card_ram.innerHTML = "&#8593;" + diferencaRam;
        div_ram.class = "card_aumento";
      } else {
        card_ram.innerHTML = "&#8595;" + Math.abs(diferencaRam);
        div_ram.class = "card_reducao";
      }
      if (diferencaDisco > 0) {
        card_disco.innerHTML = "&#8593;" + diferencaDisco;
        div_disco.class = "card_aumento";
      } else {
        card_disco.innerHTML = "&#8595;" + Math.abs(diferencaDisco);
        div_disco.class = "card_reducao";
      }
    }

    var options = {
          colors:['#1ec9d5', '#218c93', '#122178'],
          series: [
          {
            name: 'CPU',
            data: [
              {
                x: 'Outubro',
                y: 12,
              },
              {
                x: 'Novembro',
                y: 14,
              },
            ],
          },
          {
            name: 'RAM',
            data: [
              {
                x: 'Outubro',
                y: 9,
              },
              {
                x: 'Novembro',
                y: 16,
              },
            ],
          },
          {
            name: 'Disco',
            data: [
              {
                x: 'Outubro',
                y: 11,
              },
              {
                x: 'Novembro',
                y: 7,
              },
            ],
          },
        ],
          chart: {
          height: 360,
          width: 500,
          type: 'line',
        },
        plotOptions: {
          line: {
            isSlopeChart: true,
          },
        },
        legend: {
          show: true,
          position: 'top',
          horizontalAlign: 'center',
          fontSize: "15rem"
        },
        };

        var chart1 = new ApexCharts(document.getElementById("grafico1"), options);
        chart1.render();


        var options2 = {
          series: [{
          data: [5, 9]
        }],
          chart: {
          type: 'bar',
          height: 340,
          width: 500
        },
        plotOptions: {
          bar: {
            barHeight: '100%',
            distributed: true,
            horizontal: true
          }
        },
        dataLabels: {
                enabled: false
            },
        colors: ['#72bbc5', '#194554'
        ],
        xaxis: {
          categories: ['Outubro', 'Novembro'
          ],
          title: {
            text: "Horas"
          },
        },
        yaxis: {
          labels: {
            show: false
          }
        },
        legend: {
            position: "top",
            fontSize: "19rem",
            markers: {
                size: 9
            }
        }
        };

        var chart2 = new ApexCharts(document.getElementById("grafico2"), options2);
        chart2.render();
</script>