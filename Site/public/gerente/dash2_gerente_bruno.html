<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Comparação - Mês atual e meses anteriores</title>
    <link rel="shortcut icon" href="imgs/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="dash2_gerente_bruno.css">
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<!-- <body onload="listarServidores(), validarSessao('Gerente de Monitoramento de Servidores', 'dashboard_inicial_analista,html')"> -->
<body onload="mostrar_nome(), listarServidores()">
    <div class="pagina">
        <header>
            <div class="perfil">
                <div class="texto">
                    <span id="user"></span>
                </div>
            </div>
            <div class="botao">
                <div class="container">
                    <button onclick="window.location='../cadastro_estacao.html'">Cadastros</button>
                    <button onclick="window.location='../dashboard_inicial_gerente.html'">Início</button>
                    <button onclick="sair()">Sair</button>
                </div>
            </div>
        </header>
        <div class="paginaDash">
            <div class="menu">
                <div class="selects">
                    <div>
                        <span>Selecione uma linha</span>
                        <select name="linhas" id="select_linha" onchange="listarServidores()">
                            <option value="Azul">Azul</option>
                            <option value="Verde">Verde</option>
                            <option value="Vermelha">Vermelha</option>
                            <option value="Prata">Prata</option>
                        </select>
                    </div>
                    <div>
                        <span>Selecione um servidor</span>
                        <select id="select_servidor" onchange="atualizarDashboard()">
                        </select>
                    </div>
                </div>
                <div class="logo">
                    <img src="../imgs/logo.png" alt="logo" class="logo-img">
                    <a href="index.html" class="logo_txt"><span>Track</span>Secure</a>
                </div>
            </div>
            <div class="topo_dash">
                <div>
                    <span>Aumento/redução de alertas de prioridade
                      <select name="" id="select_prioridade" onchange="atualizarDashboard()">
                        <option selected value="High">Alta</option>
                        <option value="Medium">Média</option>
                        <option value="Low">Baixa</opWstion>
                    </select>
                    por componente (<span id="span_servidor"></span>) em relação a
                    <select name="" id="select_mes" onchange="atualizarDashboard()">
                        <option value="01">Janeiro</option>
                        <option value="02">Fevereiro</option>
                        <option value="03">Março</option>
                        <option value="04">Abril</option>
                        <option value="05">Maio</option>
                        <option value="06">Junho</option>
                        <option value="07">Julho</option>
                        <option value="08">Agosto</option>
                        <option value="09">Setembro</option>
                        <option selected value="10">Outubro</option>
                    </select>
                    </span>
                </div>
                <div class="cards">
                    <div>
                        <h3 style="color: #1ec9d5;">CPU</h3>
                        <div id="div_cpu"><span id="card_cpu" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                    <div>
                        <h3 style="color: #218c93;">RAM</h3>
                        <div id="div_ram"><span id="card_ram" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                    <div>
                        <h3 style="color: #122178;">Disco</h3>
                        <div id="div_disco"><span id="card_disco" style="font-size: 2rem; text-decoration: none; font-weight: bolder;"></span></div>
                    </div>
                </div>
                <div class="graficos">
                    <div>
                        <h5 id="titulo_slope_chart" style="text-align: center;"></h2>
                        <div class="quadro" id="grafico1"></div>
                    </div>
                    <hr style="width: 0.2rem; background-color: #092a45;">
                    <div>
                        <h4 id="titulo_bar_chart" style="text-align: center;"></h4>    
                        <div class="quadro" id="grafico2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    var alertasCpuMesAnterior;
    var alertasRamMesAnterior;
    var alertasDiscoMesAnterior;
    var alertasCpuMesRecente;
    var alertasRamMesRecente;
    var alertasDiscoMesRecente;

    var downtimeMesAnterior;
    var downtimeMesRecente;

    var chart1 = null;
    var chart2 = null;
    var slope_plotado = false;
    var bar_plotado = false;
    var nomeServidor = "";

    var meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro"];

    function mostrar_nome() {
        var nome = sessionStorage.NOME_USUARIO;
        user.innerHTML = `Olá, ${nome}`;
    }

    function listarServidores() {
        var fkEmpresa = sessionStorage.ID_EMPRESA;
        select_servidor.innerHTML = "";

        fetch(`/servidor/listar/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    resposta.forEach((servidor) => {
                      if (servidor.linha == select_linha.value) {
                        select_servidor.innerHTML += `<option value='${servidor.MacAddress}'>${servidor.nome}</option>`;
                      }
                });
                titulo_bar_chart.innerHTML = `Tempo total de Downtime no ${select_servidor.options[select_servidor.selectedIndex].text}`;
                titulo_slope_chart.innerHTML = `Gráfico de inclinação do aumento/redução <br> da quantidade de problemas por componente do ${select_servidor.options[select_servidor.selectedIndex].text}`;
                span_servidor.innerHTML = `${select_servidor.options[select_servidor.selectedIndex].text}`;
                buscarQtdAlertas();
                buscarHorasDowntime();
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados dos servidores: ${error.message}`);
            });
    }

    function buscarQtdAlertas() {
      var fkServidor = select_servidor.value;
      var prioridade = select_prioridade.value;
      var mes = select_mes.value;

      fetch(`/gerenteBruno/buscarQtdAlertas/'${fkServidor}'/${prioridade}/${mes}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                  alertasCpuMesAnterior = resposta[0].qtdAlertas;
                  alertasRamMesAnterior = resposta[1].qtdAlertas;
                  alertasDiscoMesAnterior = resposta[2].qtdAlertas;
                  alertasCpuMesRecente = resposta[3].qtdAlertas;
                  alertasRamMesRecente = resposta[4].qtdAlertas;
                  alertasDiscoMesRecente = resposta[5].qtdAlertas;
                  if (!slope_plotado) {
                    plotarSlopeChart();
                  } else {
                    atualizarSlopeChart();
                  }
                  atualizarQtdAlertas();
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados dos servidores: ${error.message}`);
            });
    }

    function atualizarQtdAlertas() {
      var diferencaCpu = alertasCpuMesRecente - alertasCpuMesAnterior;
      var diferencaRam = alertasRamMesRecente - alertasRamMesAnterior;
      var diferencaDisco = alertasDiscoMesRecente - alertasDiscoMesAnterior;
      if (diferencaCpu > 0) {
        card_cpu.innerHTML = `&#8593;${diferencaCpu}`;
        document.getElementById("div_cpu").className = "card_aumento";
      } else {
        card_cpu.innerHTML = `&#8595;${Math.abs(diferencaCpu)}`;
        document.getElementById("div_cpu").className = "card_reducao";
      }
      if (diferencaRam > 0) {
        card_ram.innerHTML = `&#8593;${diferencaRam}`;
        document.getElementById("div_ram").className = "card_aumento";
      } else {
        card_ram.innerHTML = `&#8595;${Math.abs(diferencaRam)}`;
        document.getElementById("div_ram").className = "card_reducao";
      }
      if (diferencaDisco > 0) {
        card_disco.innerHTML = `&#8593;${diferencaDisco}`;
        document.getElementById("div_disco").className = "card_aumento";
      } else {
        card_disco.innerHTML = `&#8595;${Math.abs(diferencaDisco)}`;
        document.getElementById("div_disco").className = "card_reducao";
      }
    }

    function plotarSlopeChart() {

      var options = {
            colors:['#1ec9d5', '#218c93', '#122178'],
            series: [
            {
              name: 'CPU',
              data: [
                {
                  x: meses[Number(select_mes.value)-1],
                  y: alertasCpuMesAnterior,
                },
                {
                  x: 'Novembro',
                  y: alertasCpuMesRecente,
                },
              ],
            },
            {
              name: 'RAM',
              data: [
                {
                  x: meses[Number(select_mes.value)-1],
                  y: alertasRamMesAnterior,
                },
                {
                  x: 'Novembro',
                  y: alertasRamMesRecente,
                },
              ],
            },
            {
              name: 'Disco',
              data: [
                {
                  x: meses[Number(select_mes.value)-1],
                  y: alertasDiscoMesAnterior,
                },
                {
                  x: 'Novembro',
                  y: alertasDiscoMesRecente,
                },
              ],
            },
          ],
            chart: {
            height: 340,
            width: 500,
            type: 'line',
          },
          plotOptions: {
            line: {
              isSlopeChart: true,
            },
          },
          legend: {
            show: true,
            position: 'top',
            horizontalAlign: 'center',
            fontSize: "15rem"
          },
          };
  
          chart1 = new ApexCharts(document.getElementById("grafico1"), options);
          chart1.render();

          slope_plotado = true;
    }

    function atualizarSlopeChart() {
      chart1.updateSeries([{
            name: 'CPU',
            data: [
              {
                x: meses[Number(select_mes.value)-1],
                y: alertasCpuMesAnterior,
              },
              {
                x: 'Novembro',
                y: alertasCpuMesRecente,
              },
            ],
          },
          {
            name: 'RAM',
            data: [
              {
                x: meses[Number(select_mes.value)-1],
                y: alertasRamMesAnterior,
              },
              {
                x: 'Novembro',
                y: alertasRamMesRecente,
              },
            ],
          },
          {
            name: 'Disco',
            data: [
              {
                x: meses[Number(select_mes.value)-1],
                y: alertasDiscoMesAnterior,
              },
              {
                x: 'Novembro',
                y: alertasDiscoMesRecente,
              },
            ],
          }])
    }

    function buscarHorasDowntime() {
      var fkServidor = select_servidor.value;
      var mes = select_mes.value;

      fetch(`/gerenteBruno/buscarHorasDowntime/'${fkServidor}'/${mes}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                  downtimeMesAnterior = resposta[0].Horas_Downtime;
                  downtimeMesRecente = resposta[1].Horas_Downtime;
                  if (!bar_plotado) {
                    plotarBarChart();
                  } else {
                    atualizarBarChart();
                  }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados dos servidores: ${error.message}`);
            });
    }

    function plotarBarChart() {
        var options2 = {
            series: [{
              name: "Valores",
              data: [downtimeMesAnterior, downtimeMesRecente]
          }],
            chart: {
            type: 'bar',
            height: 340,
            width: 500
          },
          plotOptions: {
            bar: {
              barHeight: '100%',
              distributed: true,
              horizontal: true
            }
          },
          dataLabels: {
                  enabled: false
              },
          colors: ['#72bbc5', '#194554'
          ],
          xaxis: {
            categories: [meses[Number(select_mes.value)-1], 'Novembro'
            ],
            title: {
              text: "Horas"
            },
          },
          yaxis: {
            labels: {
              show: false
            }
          },
          legend: {
              position: "top",
              fontSize: "19rem",
              markers: {
                  size: 9
              }
          }
          };

          chart2 = new ApexCharts(document.getElementById("grafico2"), options2);
          chart2.render();

          bar_plotado = true;
      }

      function atualizarBarChart() {
        chart2.updateOptions({
          series: [{
              name: "Valores",
              data: [downtimeMesAnterior, downtimeMesRecente]
          }],
          xaxis: {
            categories: [meses[Number(select_mes.value)-1], 'Novembro'
            ]
          }
        })
      }

      function atualizarDashboard() {
        buscarQtdAlertas(); 
        buscarHorasDowntime();
      }
</script>