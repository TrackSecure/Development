<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard 3º | Gerente</title>
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    <link rel="stylesheet" href="dash3_gerente_bizeli.css">
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<!-- <body onload="validarSessao('Gerente de Monitoramento de Servidores', '../dashboard_inicial_analista.html')"> -->

<body onload="mostrar_nome()">

    <div class="pagina">
        <header>
            <div class="perfil">
                <div class="texto">
                    <span id="user"></span>
                </div>
            </div>
            <div class="botao">
                <div class="container">
                    <button onclick="window.location='../cadastro_servidor.html'">Cadastros</button>
                    <button onclick="window.location='dash1_gerente_bruna.html'">Início</button>
                    <button onclick="window.location='../index.html'">Sair</button>
                </div>
            </div>
        </header>
        <div class="paginaDash">
            <div class="menu">
                <div class="container">
                    <div class="selectEsquerda">
                        <span>Selecione uma linha</span>
                        <select class="select_linha">
                            <option value="0" selected>Azul</option>
                            <option value="1">Vermelha</option>
                            <option value="2">Verde</option>
                            <option value="3">Prata</option>
                        </select>

                        <span>Selecione um servidor</span>
                        <select class="select_servidor">
                            <option value="0" selected>Servidor 1</option>
                            <option value="1">Servidor 2</option>
                            <option value="2">Servidor 3</option>
                            <option value="3">Servidor 4</option>
                        </select>

                        <span>Selecione uma Dashboard</span>
                        <select id="selectDash">
                            <option value="0" selected>Up e Downtime</option>
                            <option value="1">Análise Geral</option>
                            <option value="2">Comparação de Problemas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="topo_dash">
                <div class="titulo_servidor">
                    <h3>Servidor 1:</h3>
                </div>
                <div class="cards">
                    <div>
                        <div class="texto_esquerda_dash1">
                            <h3 style="color: #1C5C99">Horas de Uptime <br> (Ano Atual):</h3>
                        </div>
                        <div class="card_ok"><span style="font-size: 1.5rem;">
                                <div id="mensagemUptime"></div>
                            </span></div>
                    </div>
                    <div>
                        <div class="texto_esquerda_dash3">
                            <h3 style="color: #1C5C99">Horas de Downtime <br>(Ano Atual):</h3>
                            <!-- <select name="componente" id="">
                                <option selected value="">CPU</option>
                                <option value="">RAM</option>
                            </select> -->
                        </div>
                        <div class="card_critico"><span>
                                <div id="mensagemDowntime"></div>
                            </span></div>
                    </div>
                    <!-- <div>
                        <div class="texto_esquerda_dash3">
                            <h3 style="color: #1C5C99">Possível Downtime <br> (mês atual):</h3>
                        </div>
                        <div class="card_atencao"><span>64.7%</span></div>
                    </div> -->
                </div>

                <div class="graficos">
                    <div>
                        <h5 style="text-align: center;">Média de horas de Downtime do ano atual:</h5>
                        <div id="grafico1"></div>
                    </div>
                    <div>
                        <!-- <div class="texto_grafico2"> -->
                        <h5>Uptime x Downtime</h5>
                        <!-- </div> -->
                        <div id="grafico2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>

    function mostrar_nome() {
        var nome = sessionStorage.NOME_USUARIO;
        user.innerHTML = `Olá, ${nome}`;
    }

    graficoMediaHoras()

    function graficoMediaHoras() {
        const atualizarGrafico = (dados) => {
            const meses = [
                "Janeiro", "Fevereiro", "Março", "Abril", "Maio",
                "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro"
            ];

            const data = meses.map((mes, index) => ({
                x: mes,
                y: dados[index]?.qtdHoras || 0,
                goals: [
                    {
                        name: "Expected",
                        value: 3.0,
                        strokeHeight: 3,
                        strokeColor: "#5c93d6",
                    },
                ],
            }));

            var options1 = {
                series: [{ name: "Atual", data }],
                chart: {
                    height: 360,
                    width: 500,
                    type: "bar",
                },
                plotOptions: {
                    bar: { columnWidth: "60%" },
                },
                colors: ["#091e38"],
                dataLabels: { enabled: false },
                legend: {
                    show: true,
                    showForSingleSeries: true,
                    customLegendItems: ["Atual", "Esperado"],
                    markers: {
                        fillColors: ["#091e38", "#5c93d6"],
                    },
                },
            };

            if (!window.chartDiaHora) {
                window.chartDiaHora = new ApexCharts(
                    document.querySelector("#grafico1"),
                    options1
                );
                window.chartDiaHora.render();
            } else {
                window.chartDiaHora.updateOptions(options1);
            }
        };

        const buscarDados = () => {
            fetch("/gerenteEnzo/graficoMediaHoras", { method: "GET" })
                .then((resposta) => resposta.json())
                .then(atualizarGrafico)
                .catch((erro) => console.error("Erro ao buscar dados:", erro));
        };

        buscarDados();
        setInterval(buscarDados, 20000);
    }



    graficoUpDown()
    function graficoUpDown() {
        const atualizarGrafico = (dados) => {

            const upTime = dados.map(item => item.porcentagem_uptime)
            const downTime = dados.map(item => item.porcentagem_downtime)

            var options2 = {
          series: [upTime, downTime],
          chart: {
          width: 380,
          type: 'pie',
        },
        labels: ['Uptime', 'Downtime'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }]
        };

            if (!window.chartDisco) {
                window.chartDisco = new ApexCharts(document.querySelector("#grafico2"), options2);
                window.chartDisco.render();
            } else {
                window.chartDisco.updateOptions(options2);
            }
        };
        const buscarDados = () => {
            fetch("/gerenteEnzo/graficoUpDown", { method: "GET" })
                .then((resposta) => resposta.json())
                .then(atualizarGrafico)
                .catch((erro) => console.error("Erro ao buscar dados:", erro));
        };

        buscarDados();
        setInterval(buscarDados, 2000);
    }


    tempoUptime();

    function tempoUptime() {
        fetch("/gerenteEnzo/tempoUptime", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dados) {
                dados.forEach((dado) => {
                    // if(dado.Horas_Uptime > ){}
                    mensagemUptime.innerHTML = `${dado.Horas_Uptime}`;
                });
            })
        setInterval(tempoUptime, 2000000);
    }

    tempoDowntime();

    function tempoDowntime() {
        fetch("/gerenteEnzo/tempoDowntime", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dados) {
                dados.forEach((dado) => {
                    mensagemDowntime.innerHTML = `${dado.Horas_Downtime}`;
                });
            })
        setInterval(tempoDowntime, 2000000);
    }



    document.getElementById("selectDash").addEventListener("change", function () {
        var value = this.value;
        var url = "";

        if (value == "0") {
            url = "dash3_gerente_bizeli.html";
        } else if (value == "1") {
            url = "dash1_gerente_bruna.html";
        } else if (value == "2") {
            url = "dash2_gerente_bruno.html";
        }

        window.location.href = url;
    });

</script>

</html>